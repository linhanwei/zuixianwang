<?php/** * 0元淘订单管理 * * **/defined('InSystem') or exit('Access Invalid!');class zero_orderControl extends SystemControl{	public function __construct(){		parent::__construct();	}	/**	 * 订单列表	 */	public function indexOp(){            $model_zero_order = Model('zero_order');            $model_express = Model('express');            $shipping_list = $model_express->getAllList('','id,e_name');            /**             * 检索条件             */            $condition = array();            if (!empty($_GET['order_sn'])){                $condition['zero_order.order_sn'] = array('eq',$_GET['order_sn']);            }            if (is_numeric($_GET['order_state'])){                $condition['zero_order.order_state'] = array('eq',$_GET['order_state']);            }            if (!empty($_GET['buyer_name'])){                $condition['zero_order.buyer_name'] = array('eq',$_GET['buyer_name']);            }            $list = $model_zero_order->getAdminOrderList($condition,'*','','zero_order.order_state ASC,zero_order.add_time DESC', 0, 10,0);//            dump($list);die;            Tpl::output('page',$model_zero_order->showpage());            Tpl::output('list',$list);            Tpl::output('shipping_list',$shipping_list);            Tpl::output('order_sn',trim($_GET['order_sn']));            Tpl::output('order_state',trim($_GET['order_state']));            Tpl::output('buyer_name',trim($_GET['buyer_name']));            Tpl::showpage('zero_order.index');	}    /**     * 发货     */	public function shipping_goodsOp(){        $model_zero_order = Model('zero_order');        $model_express = Model('express');        $info = $model_zero_order->getInfo(array('order_id' => intval($_GET['order_id'])));        $shipping_list = $model_express->getAllList('','id,e_name');//                dump($info);        if (chksubmit()){            $obj_validate = new Validate();            $obj_validate->validateparam = array(                array("input"=>$_POST["shipping_code"], "require"=>"true", "message"=>'物流单号不能为空!'),                array("input"=>$_POST["shipping_express_id"], "require"=>"true", "message"=>'配送公司不能为空!'),            );            $error = $obj_validate->validate();            if ($error != ''){                showMessage($error);            }else {                $where = array();                $where['order_id'] = trim($_POST['order_id']);                $update_array = array();                $update_array['order_state'] = 30;                $update_array['shipping_code'] = trim($_POST['shipping_code']);                $update_array['shipping_express_id'] = trim($_POST['shipping_express_id']);                $update_array['shipping_time'] = time();                $result = $model_zero_order->editData($update_array, $where);                if ($result){                    $url = array(                        array(                            'url'=>'index.php?act=zero_order&op=shipping_goods&order_id='.trim($_POST['order_id']),                            'msg'=>'继续发货',                        ),                        array(                            'url'=>'index.php?act=zero_order&op=index',                            'msg'=>'返回订单列表',                        )                    );                    $this->log('发货['.$_POST['goods_name'].']',1);                    showMessage('保存成功',$url);                }else {                    $this->log('编辑['.$_POST['goods_name'].']',0);                    showMessage('保存失败');                }            }        }        if (empty($info)){            showMessage('参数错误');        }        Tpl::output('info',$info);        Tpl::output('shipping_list',$shipping_list);        Tpl::showpage('zero_order.shipping');    }    /**     * 导出订单记录     *     */    public function exportOp(){        $condition = array();        $order_state = $_GET['state'];        $order_sn = $_GET['order_sn'];        $buyer_name = $_GET['buyer_name'];        if($order_state){            $condition['order_state'] = $order_state;        }        if($order_sn){            $condition['order_sn'] = $order_sn;        }        if($buyer_name){            $condition['buyer_name'] = $buyer_name;        }        $model_zero_order = Model('zero_order');        //下载        $data = $model_zero_order->getAllList($condition, '*','order_state asc,add_time desc');        if($data){            $this->createExcel($data);        }else{            exit('<h1 style="width: 100%;text-align: center;">没有数据要导出</h1>');        }    }    /**     * 生成导出订单excel     *     * @param array $data     */    private function createExcel($data = array()){        Language::read('export');        import('libraries.excel');        $excel_obj = new Excel();        $excel_data = array();        //设置样式        $excel_obj->setStyle(array('id'=>'s_title','Font'=>array('FontName'=>'宋体','Size'=>'12','Bold'=>'1')));        //header        $excel_data[0][] = array('styleid'=>'s_title','data'=>'序号');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'订单号');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'支付单号');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'买家姓名');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'支付金额');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'订单状态');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'物流单号');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'配送时间');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'配送公司');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'商品名称');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'购买数量');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'支付(付款)时间');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'收货人手机号码');        $excel_data[0][] = array('styleid'=>'s_title','data'=>'收货地址');        $row = 1;        $model_express = Model('express');        $shipping_list = $model_express->getAllList('','id,e_name');        $shipping_name = '';        $order_state = '';        foreach ((array)$data as $k=>$v){            switch ($v['order_state']) {                case 0:                    $order_state = '已取消';                    break;                case 20:                    $order_state = '已付款';                    break;                case 30:                    $order_state = '已发货';                    break;                case 40:                    $order_state = '已收货';                    break;            }            foreach ($shipping_list as $sv){                if($sv['id'] == $v['shipping_express_id']){                    $shipping_name = $sv['e_name'];                }            }            $tmp = array();            $tmp[] = array('data'=>$row++);            $tmp[] = array('data'=>$v['order_sn']);            $tmp[] = array('data'=>$v['pay_sn']);            $tmp[] = array('data'=>$v['buyer_name']);            $tmp[] = array('data'=>$v['shipping_amount']);            $tmp[] = array('data'=>$order_state);            $tmp[] = array('data'=>$v['shipping_code']);            $tmp[] = array('data'=>$v['shipping_time'] ? date('Y-m-d H:i:s',$v['shipping_time']) : '');            $tmp[] = array('data'=>$shipping_name);            $tmp[] = array('data'=>$v['goods_name']);            $tmp[] = array('data'=>$v['goods_num']);            $tmp[] = array('data'=>$v['payment_time'] ? date('Y-m-d H:i:s',$v['payment_time']) : '');            $tmp[] = array('data'=>$v['tel']);            $tmp[] = array('data'=>$v['area_info'].$v['address']);            $excel_data[] = $tmp;        }        $excel_data = $excel_obj->charset($excel_data,CHARSET);        $excel_obj->addArray($excel_data);        $excel_obj->addWorksheet($excel_obj->charset('0元淘信息',CHARSET));        $excel_obj->generateXML($excel_obj->charset('0元淘信息',CHARSET).$_GET['curpage'].'-'.date('Y-m-d-H',time()));    }}