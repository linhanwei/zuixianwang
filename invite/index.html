<!doctype html>
<html>
<head>
    <meta content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"
          name="viewport">
    <meta content="application/xhtml+xml;charset=UTF-8" http-equiv="Content-Type">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta name="apple-mobile-web-app-capable" content="yes"/> <!-- apple devices fullscreen -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <title>注册</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <link rel="stylesheet" type="text/css" href="css/slot_basic.css">
    <link rel="stylesheet" type="text/css" href="css/hcz_alert.css">
    <link href="css/download.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../wap/plug-ins/swiper/swiper-3.4.0.min.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="../wap/css/common.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="../wap/css/style.css" media="all"/>
    <!--<script type="text/javascript" src="../wap/js/jquery-3.1.1.min.js"></script>-->
    <!--<script type="text/javascript" src="../wap/plug-ins/swiper/swiper-3.4.0.jquery.min.js"></script>-->
    <!--<script type="text/javascript" src="../wap/js/main.js"></script>-->
    <style>
        .u-h-toast{background-color: #fff;}
        .u-h-toast .u_toast_val{color: #000;}
    </style>
</head>

<body class="login-body">
<div class="login-logo"><img src="../wap/images/login/logo.jpg"></div>

<div class="register-box">
    <div class="input-group username">
        <input name="username" type="text" id="phoneNumId" placeholder="请输入手机号" value="">
    </div>
    <div class="input-group password">
        <input name="password" type="password" id="passwordId" placeholder="输入密码" value="">
    </div>
    <div class="input-group cpassword">
        <input name="cpassword" type="password" id="repasswordId" placeholder="确认密码" value="">
    </div>
    <div class="input-group-two code">
        <div class="input-box"><input name="code" type="text" id="verifNumId" placeholder="输入验证码" value=""></div>
        <a id="getVerNumId">获取验证码</a>
    </div>
</div>

<div class="register-btn-box">
    <a class="register-btn" id="goBtnId">注&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;册</a>
    <a href="../wap/tmpl/member/login.html" class="login-btn">登录</a>
</div>
<script type="text/javascript">
    var docEle = document.documentElement;
</script>
<script type="text/javascript" src="js/download.js"></script>
<script type="text/javascript" src="js/slot_zepto.min.js"></script>
<script type="text/javascript" src="js/slot_haojs.js?ver=20150730"></script>
<script type="text/javascript" src="js/hcz_alert.js"></script>
<script type="text/javascript" src="js/insurevalidate.js"></script>
<script type="text/javascript" src="js/address.js"></script>
<script type="text/javascript">
    var pubEndflag = false; //倒计时结束
    var countTokenNum = 0; //记录验证码错误次数
    var bindFlag = true; //记录绑定
    var timeoutFlag; //定时器标志

    $(function() {

        var rootPath = "../m/";

        //  验证码路径
        var getVerNumUrl = rootPath + 'index.php?act=login';

        // 注册路径
        var registerUrl = rootPath + 'index.php?act=login';
        //var registerUrl = '/register'
        //var registerUrl = 'http://192.168.1.88:9999/icore_aops_event/do/event/controller/callPortalInterface?iname=/points/autoRegisterAndRecommendConfirm.json';
        var inviterUrl  = rootPath + 'index.php?act=login';
        //  灰度发布
        var headers = {
            requestSource: 'outsideHtml'
        }; //请求来源

        //  一些公共变量
        var $goBtn = $('#goBtnId');
        var $getVerNum = $('#getVerNumId');
        var $phoneNum = $('#phoneNumId');
        var $verifNum = $('#verifNumId');
        var $loading = $('#loadingId');
        var cache_key = '';

        // 恢复验证码按钮初始状态
        function btnResetclsAndAct() {
            $getVerNum[0].innerHTML = '获取验证码';
            $getVerNum.removeClass('verWaitCls'); //    删除点击后的cls
            bindVerAction(); // 再次监听
        }

        //  ***********请求验证码**************
        function getVerAction(getVerNumFun) {
            var tempCheckFlag = false;
            var phoneStatus = InsureValidate.validateMobile($phoneNum.val());
            haoJs.ajax({
                type: 'post',
                url: getVerNumUrl,
                headers: headers,
                beforeSend: function() {
                    if (phoneStatus !== true) { //判断手机号格式
                        haoJs.Toast.show(phoneStatus);
                        return false;
                    } else {
                        $getVerNum.unbind('click', getVerNumFun); //    解除绑定
                        $getVerNum.addClass('verWaitCls'); //   增加点击后的cls
                        haoJs.countDownSixty($getVerNum[0], 60, function() {
                            btnResetclsAndAct();
                        });
                        tempCheckFlag = true;
                        return true;
                    }
                },
                data: {
                    mobile_phone: $phoneNum.val(),
                    client_type: 'wap',
                    op: 'check_phone'
                },
                success: function(result) {
                    var tResult = result.datas;
                    if (tResult.code == 'success' && tResult.msg) {
                        cache_key = tResult.msg;
                        bindAddCarBtn(); //开始绑定下载按钮
                        countDown(); //开始倒计时 验证码两分钟有效
                        countTokenNum = 0;
                    } else if (tResult.code == 'exist') {
                        haoJs.Toast.show('该手机号已经被注册！', function() {
                            pubEndflag = true;
                            btnResetclsAndAct();
                        });
                    } else {
                        haoJs.Toast.show('验证码获取失败！', function() {
                            pubEndflag = true;
                            btnResetclsAndAct();
                        });
                    }
                },
                error: function() {
                    if (tempCheckFlag) {
                        haoJs.Toast.show('验证码获取失败！', function() {
                            pubEndflag = true;
                            btnResetclsAndAct();
                        });
                    }
                }
            })
        }

        //  绑定获得验证码按钮
        function bindVerAction() {
            $getVerNum.bind('click', function getVerNumFun() {
                getVerAction(getVerNumFun);
            });
        }
        bindVerAction();

        function bindRegAction() {
            //$('#form2Id').removeClass('disnone');



            $('#usernameId').val($phoneNum.val());
            doRegAction(function() {
                $loading.css('display', 'block')
//                haoJs.centerWindow($loading.get(0)); // loading居中 只有在display为block才能获得宽度
            }, function() {
                $loading.css('display', 'none');
            });
            /*$('#goBtn2Id').bind('click', function getVerNumFun() {
             $('#goBtn2Id').unbind('click', addClickFun);
             doRegAction(function() {
             $loading.css('display', 'block')
             haoJs.centerWindow($loading.get(0)); // loading居中 只有在display为block才能获得宽度
             }, function() {
             $loading.css('display', 'none');
             });
             });
             */
        }

        function doRegAction(ajaxBefore, ajaxAfter) {
            var flagVal = false;
            haoJs.ajax({
                type: 'post',
                url: registerUrl,
                headers: headers,
                beforeSend: function() {
                    if ($('#usernameId').val() == '') {
                        haoJs.Toast.show('请输入用户名');
                        return false;
                    } else if ($('#passwordId').val() == '') {
                        haoJs.Toast.show('请输入密码');
                        return false;
                    } else if($('#region_select').val() == ''){
                        haoJs.Toast.show('请选择所在地');
                        return false;
                    }else if ($('#passwordId').val() != $('#repasswordId').val()) {
                        haoJs.Toast.show('两次密码不一致');
                        return false;
                    }  else {
                        $('#formId').addClass('disnone');
                        ajaxBefore();
                        flagVal = true;
                        $('#passwordIdShow').val($('#passwordId').val());
                        return true;
                    }
                },
                data: {
                    mobile_phone: $phoneNum.val(),
                    username: $phoneNum.val(),
                    password: $('#passwordId').val(),
                    password_confirm: $('#passwordId').val(),
                    member_province:$('#prov_select').val(),
                    member_city:$('#city_select').val(),
                    member_region:$('#region_select').val(),
                    for_platform : 'inviter',
                    invite_code: $('#inviter_name').val(),
                    identifying_code:$('#verifNumId').val(),
                    cache_key:cache_key,
                    client:'wap',
                    email:'',
                    op: 'register'
                },
                success: function(dResult) {
                    var tResult = dResult;
                    if (tResult.datas.error) {
                        haoJs.Toast.show(tResult.datas.error);
                        $('#formId').removeClass('disnone');
                    }else{
                        if(typeof(tResult.datas.username) != 'undefine'){
                            haoJs.Toast.show('注册成功');

                            $('#form3Id').removeClass('disnone');
                            $('#form2Id').removeClass('disnone');
                        }else{
                            haoJs.Toast.show('注册失败');
                            $('#formId').removeClass('disnone');
                        }

                    }
                },
                complete: function() {
                    ajaxAfter(); //loading去除
                },
                error: function() {
                    if (flagVal) {
                        haoJs.Toast.show('网络异常！');
                    }
                }
            });
        }

        //  **********点击下载************
        function downloadAction(ajaxBefore, ajaxAfter) {
            var phoneStatus = InsureValidate.validateMobile($phoneNum.val());
            if (phoneStatus !== true) {
                haoJs.Toast.show(phoneStatus);
                return false;
            } else if (!haoJs.regverifNumber(haoJs.trim($verifNum.val()))) {
                haoJs.Toast.show('请输入正确的验证码');
                return false;
            } else {
                bindRegAction();
                return true;
            }
        }

        //  点击下载按钮
        var carBtnFlag;

        function bindAddCarBtn() {

            $goBtn.removeClass('unUsed');
            $goBtn.bind('click', addClickFun = function() {
                //$goBtn.unbind('click', addClickFun);
                downloadAction(function() {
                    $loading.css('display', 'block')
//                    haoJs.centerWindow($loading.get(0)); // loading居中 只有在display为block才能获得宽度
                }, function() {
                    $loading.css('display', 'none')
                    if (bindFlag) {
                        if (carBtnFlag) {
                            clearTimeout(carBtnFlag);
                        }
                        carBtnFlag = setTimeout(bindAddCarBtn, 1500);
                    } else {
                        $verifNum.val('');
                        $goBtn.addClass('unUsed');
                        bindFlag = true
                        clearTimeout(timeoutFlag); //解除验证码定时器绑定
                        countTokenNum = 0;
                    }

                });
            });

        }

        //倒计时120秒
        function countDown() {
            if (timeoutFlag) {
                clearTimeout(timeoutFlag);
            }
            timeoutFlag = setTimeout(function() {
                countTokenNum = 4;
            }, 120000);
        }

        haoJs.ajax({
            type: 'post',
            url: inviterUrl,
            headers: headers,
            beforeSend: function() {

            },
            data: {
                member_id: haoJs.getParams("i"),
                client:'wap_inviter',
                email:'',
                op: 'get_inviter'
            },
            success: function(dResult) {
                // console.log(dResult);
                if(dResult.datas.inviter_name){
                    $('#inviter_name').val(dResult.datas.inviter_name);
                    $('#inviter').show();
                }

            }
        });
    })
</script>
</body>
</html>
